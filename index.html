<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />

<style id="webmakerstyle">
body {
  background: black;
}
canvas {
  border: 1px solid white;  
} 
</style>
</head>
<body>
  <canvas width="720" height="480" id="canvas"></canvas>

<script src="kontra9.min.js"></script>
<script src="player-small.js"></script>
<script src="Javabox1.js"></script>
<script src="SoundboxDeath.js"></script>
<script src="https://sfxr.me/riffwave.js"></script>
<script src="https://sfxr.me/sfxr.js"></script>
<script src="sounds.js"></script>
<script src="tinyfont.js"></script>

<script>
let { init, Sprite, SpriteSheet, GameLoop, initKeys, keyPressed, initGamepad, gamepadPressed, gamepadAxis } = kontra

let { canvas, context } = init();

  // Initialize music generation (player).
  var playerz = new CPlayer();
  playerz.init(song);
  var playerz_death = new CPlayer();
  playerz_death.init(death_song);
  var death_wave;
  var song1_wave_src;
  var death_wave_src;

  // Generate music...
  var done = false;
  var audio;
  setInterval(function () {
    if (done) {
      return;
    }

    done = playerz.generate() >= 1;

    if (done) {
      var t1 = new Date();
      //s.textContent = s.textContent + "done (" + (t1 - t0) + "ms)";

      // Put the generated song in an Audio element.
      var wave = playerz.createWave();
      audio = document.createElement("audio");
      song1_wave_src = URL.createObjectURL(new Blob([wave], {type: "audio/wav"}));
      audio.src = song1_wave_src;
      audio.loop = true;
      audio.play();
    }
  });

  var done_death = false
  playerz_death.init(death_song);

  setInterval(function () {
    if (done_death) {
      return;
    }

    done_death = playerz_death.generate() >= 1;

    if (done_death) {
      death_wave = playerz_death.createWave();
      death_wave_src = URL.createObjectURL(new Blob([death_wave], {type: "audio/wav"}));
    }
  });

var pickup_audio = sfxr.toAudio(pickup_sound);
var level_audio = sfxr.toAudio(level_sound);

var canvasX = 720;
var canvasY = 480;
var level = 1;
var countdownStart = 5;
var levelEndScore = 20;
var score = 0;
var timer = countdownStart;

initKeys();
initGamepad();

let image = new Image();
image.src = 'player_sheet_128.png'
image.onload = function() {
    let spriteSheet = SpriteSheet({
        image: image,
        frameWidth: 32,
        frameHeight: 32,
        animations: {
            idle: {
                frames: [0, 1, 2],
                frameRate: 30,
                loop: true,
            },
            walk: {
                frames: [4, 5, 6, 7],
                frameRate: 30,
                loop: true,
            },
            die: {
                frames: 10,
                frameRate: 30,
                loop: false,
            }
        }
    });

    let player = Sprite({
  speed: 3,
  isMoving: false,
  x: 360,        // starting x,y position of the sprite
  y: 240,
  anchor: {x: 0.5, y: 0.5},       // move the sprite 2px to the right every frame
  animations: spriteSheet.animations,
  update() {
    // check the axis of the gamepad connected to index 0
    let axisX = gamepadAxis('leftstickx', 0);
    let axisY = gamepadAxis('leftsticky', 0);

    this.isMoving = false;

    if (axisX < -0.4 || keyPressed(['arrowleft', 'a'])) {
      this.x -= 1*this.speed;
      this.isMoving = true;
    }
    else if (axisX > 0.4 || keyPressed(['arrowright', 'd'])) {
      this.x += 1*this.speed;
      this.isMoving = true;
    }

    if (axisY < -0.4 || keyPressed(['arrowup', 'w'])) {
      this.y -= 1*this.speed;
      this.isMoving = true;
    }
    else if (axisY > 0.4 || keyPressed(['arrowdown', 's'])) {
      this.y += 1*this.speed;
      this.isMoving = true;
    }

    for(var i = 0; i < letterz.length; i++) {
      var playerMidX = this.x;
      var playerMidY = this.y;
      let lett = letterz[i];

      if(playerMidX >= lett.x && playerMidX <= lett.x + lett.width && playerMidY >= lett.y && playerMidY <= lett.y + lett.height) {
        pickup_audio.play();
        score += parseInt(lett.content);
        timer += parseInt(lett.content);
        
        if (scorez.content.includes("13")) {
            score = 0;
        }

        if (score >= levelEndScore) {
            score = 0;
            level += 1;
            levelz.content = 'Level: ' + level;
            level_audio.play();
        }
        scorez.content = 'Score: ' + score;

        lett.ttl = 0;
      }
    }

    if (this.isMoving) {
        if (this.currentAnimation.name != 'walk') {
            this.playAnimation('walk');
        }
        
    } else {
        if (this.currentAnimation.name != 'idle') {
            this.playAnimation('idle');
        }
    }

    this.advance();

  }
});

    let letterz = [];

function createLetter() {
  let letter = Sprite({
    content: Math.floor((Math.random()*8)+1).toString(),
    speed: 1,
    x: Math.floor(Math.random()*canvasX),        // starting x,y position of the sprite
    y: 0,
    color: '#eeeeee',  // fill color of the sprite rectangle
    width: 20,     // width and height of the sprite rectangle
    height: 20,        // move the sprite 2px to the right every frame
    update() {
      this.y += 1*this.speed;
    },
    render() {
      draw(this.content, 4, this.color);
    }
  });
  letterz.push(letter);
}

let levelz = Sprite({
    content: 'Level: ' + level,
    x: 5,        // starting x,y position of the sprite
    y: 5,
    color: '#eeeeee',  // fill color of the sprite rectangle
    width: 20,     // width and height of the sprite rectangle
    height: 20,        // move the sprite 2px to the right every frame
    update() {
      
    },
    render() {
      draw(this.content, 4, this.color);
    }
  });

let scorez = Sprite({
    content: 'Score: ' + score,
    x: 5,        // starting x,y position of the sprite
    y: 30,
    color: '#eeeeee',  // fill color of the sprite rectangle
    width: 20,     // width and height of the sprite rectangle
    height: 20,        // move the sprite 2px to the right every frame
    update() {
      if (this.content.includes("13")) {
        this.color = '#FF0000';
      } else {
        this.color = '#eeeeee';
      }
    },
    render() {
      draw(this.content, 4, this.color);
    }
  });

let timerz = Sprite({
    content: 'Time Left: ' + timer,
    x: 5,        // starting x,y position of the sprite
    y: 55,
    color: '#eeeeee',  // fill color of the sprite rectangle
    width: 20,     // width and height of the sprite rectangle
    height: 20,        // move the sprite 2px to the right every frame
    update() {
      this.content = 'Time Left: ' + timer;
      if (timer < 10) {
        this.color = '#FF0000';
      } else {
        this.color = '#eeeeee';
      }
    },
    render() {
      draw(this.content, 4, this.color);
    }
  });

setInterval(countDown, 1000);

function countDown() {
    timer -= 1;
}

let loop = GameLoop({  // create the main game loop
  update: function(dt) { // update the game state
    if (player.isAlive()) {
        levelz.update();
        scorez.update();
        timerz.update();
        player.update();

        // wrap the sprites position when it reaches
        // the edge of the screen
        if (player.x > canvas.width) {
          player.x = 0;
        }
        if (player.x < 0) {
          player.x = canvas.width;
        }

        letterz.map(letter => {
          letter.update();

          if (letter.y + letter.height > canvasY) {
            letter.ttl = 0;
          }
        });

        letterz = letterz.filter(letter => letter.isAlive());
        if (letterz.length < 1) {
          for(var i = 0; i < 6; i++) {
            createLetter();
          }
        }

        if (timer < 1) {
            die();
        }

        scorez.update();
    } else {
        if (gamepadPressed('south') || keyPressed(['r', 'enter', 'space'])) {
            restart();
        }
    }
  },
  render: function() { // render the game state
    player.render();

    letterz.map(letter => {
      letter.render();
    });

    levelz.render();
    scorez.render();
    timerz.render();
  }
});

new_game();
loop.start();    // start the game

function die() {
    player.ttl = 0;
    player.playAnimation('die');
    letterz.filter(letter => { letter.ttl = 0; })
    audio.pause();
    audio.currentTime = 0;
    audio.src = death_wave_src;
    audio.loop = false;
    audio.play();
};

function new_game() {
    level = 1;
    levelz.content = 'Level: ' + level;
    score = 0;
    scorez.content = 'Score: ' + score;
    timer = countdownStart;
    timerz.content = 'Time Left: ' + timer;

    for(var i = 0; i < 6; i++) {
        createLetter();
    }
    player.x = canvasX/2;
    player.y = canvasY/2;
    player.ttl = Infinity;
};

function restart() {
    level = 1;
    levelz.content = 'Level: ' + level;
    score = 0;
    scorez.content = 'Score: ' + score;
    timer = countdownStart;
    timerz.content = 'Time Left: ' + timer;

    for(var i = 0; i < 6; i++) {
        createLetter();
    }
    player.x = canvasX/2;
    player.y = canvasY/2;
    player.ttl = Infinity;
    audio.src = song1_wave_src;
    audio.loop = loop;
    audio.play();
};

};





</script>
</body>
</html>